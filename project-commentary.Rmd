---
title: "NARC Data Harmonisation"
author: "Victor Ordu"
date: "22 January 2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

This is the main file that contains the script that will be used to harmonise the data bases as requested. What it essentiall does is:

1. Look for Excel files in the folder.
2. Load the spreadsheets into R.
3. Find that actual cells that contain the data.
4. Applies a new column header.
5. Rearranges the different datasets into a similar shape.
6. Joins the different datasets.
7. Changes the data types used to store them in an appropriate form.
8. Stores the data into a SQLite database file.

The details of the script are shown below. I have tried to make it rich with comments (the parts preceded by a **#**) for readability. Ideas and comments are welcome.

**narc-dfmerge.R**
```{r}
# narc-dfmerge.R

## Copyright (c) 2018 Dev Solutions

library(readxl)
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(dplyr))
library(RSQLite)

source("helpers.R")

notice()

cat("Checking for Excel files in the directory..,\n")
excelfiles <- list.files(pattern = ".xlsx$|.xls$")
numFiles <- length(excelfiles)
if (!numFiles) {
    cat("Not Found")
    stop("There are no Excel files in this directory")
} else {
    cat(sprintf(
        ngettext(
            numFiles,
            "\t%d Excel file was found:\n",
            "\t%d Excel files were found:\n"
        ),
        numFiles
    ))
    
    ## List the files
    invisible(sapply(excelfiles, function(x) {
        cat(sprintf("\t  * %s\n", x))
    }))
}

cat("Creating a header for the new data frame... ")
columnNames <- c(
    "serialno",
    "name",
    "phone",
    "address",
    "email",
    "birthday",
    "anniversary",
    "occupation",
    "church",
    "pastor",
    "info.source"
)
cat("Done\n")

cat("Importing the data from Excel into R... ")
df.ls <- sapply(excelfiles, read_excel, na = "NA")
cat("Done\n")

cat("Identifying and afixing original headers... ")
df.ls <- lapply(df.ls, function(df) {
    val <- locate_header(df, hdr = columnNames)
    df <- df %>%
        slice(val$nextrow:n())
    
    if (!identical(ncol(df), length(val$header)))
        stop("Mismatched dimensions of existing and updated headers.")
    colnames(df) <- val$header
    df
})
cat("Done\n")

cat("Updating original headers... ")
df.ls <- lapply(df.ls, update_header, newCol = columnNames)
cat("Done\n")

cat("Rearranging columns to suit the prescribed format... ")
df.ls <- lapply(df.ls, rearrange_df, columnNames)
cat("Done\n")

cat("Merging data frames... ")
master <- combine_dfs(df.ls)
cat("Done\n")

cat("Setting types... ")
master <- set_datatypes(master)
cat("Done\n")

cat("Creating output directory... ")
folder <- "harmonised-data"
if (!dir.exists(folder))
    dir.create(folder)
cat("Done\n")

cat("Writing to database... ")
dbFile <- "NARC-mailing-list.db"
con <- dbConnect(SQLite(), file.path(folder, dbFile))
dbWriteTable(conn = con, "NARC_mail", master)
dbDisconnect(con)
cat("Done\n")

cat("\nThat's all.\n")

```


These are the helper functions that were custom-built to carry out some of the tasks in the script. Without this file in the same directory at the time of running the script, `narc-dfmerge.R` will not work.

**helpers.R**
```{r}
# helpers.R

## Definitions of custom functions created for 'narc-dfmerge.R'


## Finds the row that likely contains the actual header and
## returns an S3 object that is a marker to the row it occupies
locate_header <- function(df, hdr, quietly = TRUE) {
    if (!is.data.frame(df))
        stop("'df' is not a valid data frame")
    if (!is.character(hdr))
        stop("'hdr' is not a character vector")
    
    ## Iterate row-wise
    val <- list()
    for (i in 1:nrow(df)) {
        ## Check whether we hit something that looks like column names
        ## and when we do, stop looking.
        if (any(hdr %in% tolower(df[i, ]))) {
            if (!quietly) {
                cat(
                    paste0(
                        "\tA header candidate was found on row ",
                        i,
                        ":\n\t"
                    ),
                    sQuote(df[i, ]),
                    "\n"
                )
            }
            hdr <- as.character(df[i,])
            val <- structure(
                list(header = hdr,
                     rownum = i,
                     nextrow = i + 1),
                class = "header-locator"
            )
            break
        }
    }
    invisible(val)
}

## Updates old column names of the data frame with the new
## ones that are to be used in the harmonised version
update_header <- function(df, newCol) {
    if (!is.data.frame(df))
        stop("'df' is not a valid data frame")
    if (!is.character(newCol))
        stop("'newCol' is not a character vector")
    
    initialHdr <- colnames(df)
    modifiedHdr <- sapply(initialHdr, function(x) {
        
        ## These are the values we're picking from 'newCol':
        ### [1] "serialno"     [2] "name"          [3] "phone" 
        ### [4] "address"      [5] "email"         [6] "birthday" 
        ### [7] "anniversary"  [8] "occupation"    [9] "church"
        ### [10] "pastor"      [11] "info.source"
        if (identical(x, "S/N"))
            x <- newCol[1]
        else if (grepl("name", tolower(x)))
            x <- newCol[2]
        else if (grepl("number|phone", tolower(x)))
            x <- newCol[3]
        else if (grepl("ress$", tolower(x)))
            x <- newCol[4]
        else if (identical(tolower(x), newCol[5]))
            x <- newCol[5]
        else if (regexpr("day", tolower(x)) > 0) # review this step?
            x <- newCol[6]
        else if (identical(tolower(x), "wed ann"))
            x <- newCol[7]
        else if (grepl("Occupation", x))
            x <- newCol[8]
        else if (grepl("church", tolower(x)))
            x <- newCol[9]
        else if (grepl("pastor$", tolower(x)))
            x <- newCol[10]
        else if (grepl("know", tolower(x)))
            x <- newCol[11]
    })
    colnames(df) <- modifiedHdr
    invisible(df)
}


## Rearranges the columns of data frames to suit the prescribed
## format. Columns without values are assigned NA.
rearrange_df <- function(df, hdr) {
    if (!is.data.frame(df))
        stop("'df' is not a valid data frame.")
    if (!is.character(hdr))
        stop("'hdr' ought to be a character vector.")
    
    height <- nrow(df)
    oldHeader <- colnames(df)
    newDf <- data.frame(seq_along(height))
    
    for (i in 2:length(hdr)) {
        x <- hdr[i]
        
        if (x %in% oldHeader) {
            index <- match(x, oldHeader)
            newCol <- df[, index]
        } else {
            newCol <- rep(NA, height)
        }
        
        newDf <- cbind(newDf, newCol)
    }
    
    colnames(newDf) <- hdr
    newDf
}

## Combines all the data frames in the list into one master data frame
combine_dfs <- function(dfs) {
    final <- dfs[[1]]
    for (i in 2:length(dfs)) {
        singleton <- dfs[[i]]
        final <- bind_rows(final, singleton)
    }
    final
}

## Setting the columns to the appropriate data types
set_datatypes <- function(df) {
    cat("(NB: Yet to fix date columns!!!) ")
    df$serialno <- as.integer(df$serialno)
    df$phone <- fix_phone_numbers(df$phone)
    for (i in c(2, 4:5))
        df[[i]] <- as.character(df[[i]])
    for (i in c(8:11))
        df[[i]] <- as.factor(df[[i]])
    
    invisible(df)
}

## Fixing up phone number to a uniform text format
fix_phone_numbers <- function(column) {
    invisible(column <- column %>%
                  as.character() %>%
                  gsub("^([1-9])", "0\\1", .))
}

    
notice <- function() {
    cat("Copyright (c) Dev Solutions 2018. All rights reserved.\n")
    cat("  NOTICE: This software is provided without any warranty.\n\n")
}

```

When all things go as expected, this is a sample of what the output would look like

```
Copyright (c) Dev Solutions 2018. All rights reserved.
  NOTICE: This software is provided without any warranty.

Checking for Excel files in the directory..,
	8 Excel files were found:
	  * apostle tetsola program june 2015.xlsx
	  * Book1.xlsx
	  * BWK JUNE 2014.xlsx
	  * database-for-test.xls
	  * NC CONTACTS REGIONAL internal.xlsx
	  * NC GENERAL.xlsx
	  * NEHEMIAH COMPANY REBUILDING LIVES PROJECT EDITED MAY 2017 (1).xlsx
	  * NEHEMIAH COMPANY TETSOLA ATTENDANCE (1).xlsx
Creating a header for the new data frame... Done
Importing the data from Excel into R... Done
Identifying and afixing original headers... Done
Updating original headers... Done
Rearranging columns to suit the prescribed format... Done
Merging data frames... Done
Setting types... (NB: Yet to fix date columns!!!) Done
Creating output directory... Done
Writing to database... Done

That's all.
```

Victor Ordu
For Dev Solutions